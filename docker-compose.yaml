services:
  registry:
    image: registry:2
    restart: unless-stopped
    volumes:
      - registry-data:/var/lib/registry
    environment:
      REGISTRY_HTTP_SECRET: ${SERVICE_BASE64_REGISTRY}
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:5000/v2/"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  # Init container to fix volume permissions for non-root user
  openclaw-init:
    image: busybox:latest
    volumes:
      - openclaw-config:/data/.openclaw
      - openclaw-workspace:/data/openclaw-workspace
      - openclaw-bun:/data/.bun
      - openclaw-npm:/data/.npm-global
      - openclaw-npm-cache:/data/.npm-cache
      - openclaw-local:/data/.local
      - openclaw-pip-cache:/data/.pip-cache
      - openclaw-go:/data/go
      - openclaw-cache:/data/.cache
      - openclaw-cargo:/data/.cargo
    command: >
      sh -c "
        chown -R 999:999 /data/.openclaw /data/openclaw-workspace /data/.bun /data/.npm-global /data/.npm-cache /data/.local /data/.pip-cache /data/go /data/.cache /data/.cargo 2>/dev/null || true;
        echo 'Permissions fixed'
      "
    restart: "no"

  openclaw:
    build:
      context: .
      args:
        - OPENCLAW_BETA=${OPENCLAW_BETA:-false}
    restart: on-failure:10
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    env_file:
      - .env
    # Security: Run as non-root user (openclaw:openclaw)
    # This matches the Dockerfile user setup
    user: "999:999"
    environment:
      DOCKER_HOST: tcp://docker-proxy:2375
      OPENCLAW_ENABLE_WEBHOOK_PROXY: "1"
      PORT: 18789
      NODE_ENV: production
      NODE_OPTIONS: "--max-old-space-size=4096"
      # CRITICAL: Set HOME to non-root user home
      HOME: /home/openclaw
      TERM: xterm-256color
      # Persistence: Command History
      HISTFILE: /home/openclaw/.openclaw/.bash_history
      HISTSIZE: 50000
      HISTSAVE: 50000
      HISTCONTROL: ignoreboth

      # Tool Paths - All user-writable locations
      # BUN
      BUN_INSTALL: /home/openclaw/.bun
      BUN_INSTALL_GLOBAL_DIR: /home/openclaw/.bun/install/global
      BUN_INSTALL_CACHE_DIR: /home/openclaw/.bun/cache
      # NPM
      NPM_CONFIG_PREFIX: /home/openclaw/.npm-global
      npm_config_cache: /home/openclaw/.npm-cache
      # Python
      PYTHONUSERBASE: /home/openclaw/.local
      PIP_CACHE_DIR: /home/openclaw/.pip-cache
      PIP_BREAK_SYSTEM_PACKAGES: "1"
      PYTHON_KEYRING_BACKEND: keyring.backends.null.Keyring
      # Go
      GOPATH: /home/openclaw/go
      GOCACHE: /home/openclaw/.cache/go-build
      GOMODCACHE: /home/openclaw/go/pkg/mod
      # UV
      UV_INSTALL_DIR: /home/openclaw/.cargo/bin
      # XDG
      XDG_CACHE_HOME: /home/openclaw/.cache
      XDG_CONFIG_HOME: /home/openclaw/.config
      # Map OpenClaw vars
      OPENCLAW_GATEWAY_BIND: lan
      OPENCLAW_GATEWAY_PORT: ${OPENCLAW_GATEWAY_PORT:-18789}
      # Tell the binary where to look for state/config
      OPENCLAW_STATE_DIR: /home/openclaw/.openclaw
      OPENCLAW_WORKSPACE: /home/openclaw/openclaw-workspace

      # API Keys injected from .env or Coolify
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      MINIMAX_API_KEY: ${MINIMAX_API_KEY}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      GEMINI_API_KEY: ${GEMINI_API_KEY}
      KIMI_API_KEY: ${KIMI_API_KEY}
      OPENCODE_API_KEY: ${OPENCODE_API_KEY}
      MOONSHOT_API_KEY: ${KIMI_API_KEY}
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      SANDBOX_CONTAINER: ${SANDBOX_CONTAINER:-false}

      # Optional integrations
      GOOGLE_MAPS_API_KEY: ${GOOGLE_MAPS_API_KEY}
      NANOBANANA_API_KEY: ${NANOBANANA_API_KEY}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY}

      SERVICE_URL_OPENCLAW_18789: null
      SERVICE_URL_OPENCLAWWEBHOOK_8788: null
      BASE_URL: "https://${SERVICE_FQDN_OPENCLAW}"
      PUBLIC_URL: "https://${SERVICE_FQDN_OPENCLAW}"
      # Bootstrap controls
      OPENCLAW_AUTO_BOOTSTRAP: "1"
      OPENCLAW_PRINT_ACCESS: "1"
      # Security: Restrict trusted proxies to private IP ranges only
      # Prevents IP spoofing attacks via X-Forwarded-For headers
      GATEWAY_TRUSTED_PROXIES: "127.0.0.1,10.0.0.0/8,172.16.0.0/12,192.168.0.0/16"
      # Fix for EMFILE/Inotify issues in Docker
      CHOKIDAR_USEPOLLING: "true"
      # Public URL Access

      CF_TUNNEL_TOKEN: ${CF_TUNNEL_TOKEN}
      # Deployment & Git
      VERCEL_ORG_ID: ${VERCEL_ORG_ID}
      VERCEL_PROJECT_ID: ${VERCEL_PROJECT_ID}
      VERCEL_TOKEN: ${VERCEL_TOKEN}
      GITHUB_TOKEN: ${GITHUB_TOKEN}
      GITHUB_USERNAME: ${GITHUB_USERNAME}
      GITHUB_EMAIL: ${GITHUB_EMAIL}
      # Optional
      OPENCLAW_BETA: ${OPENCLAW_BETA:-false}

    volumes:
      # Persist user configuration and installed tools
      - openclaw-config:/home/openclaw/.openclaw
      - openclaw-workspace:/home/openclaw/openclaw-workspace
      # Persist tool installations across restarts
      - openclaw-bun:/home/openclaw/.bun
      - openclaw-npm:/home/openclaw/.npm-global
      - openclaw-npm-cache:/home/openclaw/.npm-cache
      - openclaw-local:/home/openclaw/.local
      - openclaw-pip-cache:/home/openclaw/.pip-cache
      - openclaw-go:/home/openclaw/go
      - openclaw-cache:/home/openclaw/.cache
      - openclaw-cargo:/home/openclaw/.cargo

      # Secure: Socket mount removed in favor of proxy
      # - /var/run/docker.sock:/var/run/docker.sock

    depends_on:
      docker-proxy:
        condition: service_started
      openclaw-init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:18789/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 4G
        reservations:
          cpus: "0.5"
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    # Security: Read-only root filesystem with tmpfs for writable areas
    read_only: true
    tmpfs:
      - /tmp
      - /var/tmp
    # Security: Traefik labels for Coolify proxy with security headers
    labels:
      # Enable Traefik proxy
      - traefik.enable=true
      # Security headers middleware
      - "traefik.http.middlewares.openclaw-security.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.openclaw-security.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.openclaw-security.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.openclaw-security.headers.browserXssFilter=true"
      - "traefik.http.middlewares.openclaw-security.headers.frameDeny=true"
      - "traefik.http.middlewares.openclaw-security.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.openclaw-security.headers.permissionsPolicy=camera=(), microphone=(), geolocation=()"
      # Apply middleware to router
      - "traefik.http.routers.openclaw.middlewares=openclaw-security"

    command: ["bash", "/app/scripts/bootstrap.sh"]

  docker-proxy:
    image: tecnativa/docker-socket-proxy:latest
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      LOG_LEVEL: info
      # Security: Only enable necessary Docker APIs
      # EXEC disabled: Prevents arbitrary command execution in containers
      # Only allow container lifecycle management, not exec
      POST: 1 # Create containers
      CONTAINERS: 1 # List/manage containers
      IMAGES: 1 # Pull images
      NETWORKS: 1 # Connect to networks
      INFO: 1 # Version check
      VERSION: 1
      # EXEC: 0 # DISABLED: Prevents container escape via exec
      EVENTS: 1 # Listen for events (if needed)
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.1"
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

  #  qdrant:
  #    image: qdrant/qdrant:latest
  #    restart: unless-stopped
  #    volumes:
  #      - qdrant-data:/qdrant/storage

  #  linkding:
  #    image: sissbruecker/linkding:latest
  #    restart: unless-stopped
  #    volumes:
  #      - linkding-data:/etc/linkding/data
  #    environment:
  #      - LD_DISABLE_BACKGROUND_TASKS=False
  #      - LD_DISABLE_URL_VALIDATION=False

  #  miniflux:
  #    image: miniflux/miniflux:latest
  #    restart: unless-stopped
  #    depends_on:
  #      - miniflux-db
  #    environment:
  #      - DATABASE_URL=postgres://miniflux:secret@miniflux-db/miniflux?sslmode=disable
  #      - RUN_MIGRATIONS=1
  #      - CREATE_ADMIN=1
  #      - ADMIN_USERNAME=admin
  #      - ADMIN_PASSWORD=admin123
  #      - BASE_URL=http://localhost:8080

  #  miniflux-db:
  #    image: postgres:15-alpine
  #    restart: unless-stopped
  #    environment:
  #      - POSTGRES_USER=miniflux
  #      - POSTGRES_PASSWORD=secret
  #      - POSTGRES_DB=miniflux
  #    volumes:
  #      - miniflux-db:/var/lib/postgresql/data

  searxng:
    build:
      context: .
      dockerfile: searxng/Dockerfile
    restart: unless-stopped

    volumes:
      - searxng-data:/var/lib/searxng

    environment:
      SEARXNG_BASE_URL: http://searxng:8080
      SEARXNG_SERVER_SECRET_KEY: ${SERVICE_BASE64_SEARXNG}

    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M
        reservations:
          cpus: "0.1"
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"

volumes:
  openclaw-config:
  openclaw-workspace:
  openclaw-bun:
  openclaw-npm:
  openclaw-npm-cache:
  openclaw-local:
  openclaw-go:
  openclaw-pip-cache:
  openclaw-cache:
  openclaw-cargo:
  searxng-data:
  registry-data:
#  qdrant-data:
#  linkding-data:
#  miniflux-db:
